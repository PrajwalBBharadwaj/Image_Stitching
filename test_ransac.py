from stitch import compute_matrix
import cv2

import numpy as np

points_1 = [(12.04, 185.47), (12.16, 197.78), (142.63, 193.21), (142.86, 186.97), (142.86, 186.97), (148.9, 185.67), 
 (166.16, 164.49), (280.03, 197.13), (280.29, 191.69), (286.33, 189.94), (299.89, 208.86), (301.66, 157.96),
   (303.53, 227.2), (304.39, 197.8), (304.57, 191.91), (304.57, 191.91), (305.0, 184.95), (305.45, 168.54),
     (305.45, 168.54), (306.6, 240.62), (310.17, 224.83), (310.37, 129.63), (310.44, 161.38), (311.27, 168.4),
       (311.63, 134.38), (312.34, 232.3), (314.59, 150.63), (314.64, 147.47), (315.32, 129.73), (315.32, 180.4),
         (315.99, 219.27), (316.22, 214.07), (316.36, 204.32), (316.36, 204.32), (316.39, 185.22), (316.42, 199.65),
           (316.55, 193.74), (316.55, 193.74), (317.54, 177.86), (317.91, 165.82), (318.84, 129.18), (318.84, 129.18),
             (318.98, 160.42), (319.49, 141.04), (320.28, 227.1), (320.3, 214.25), (320.51, 156.98), (322.41, 129.9),
               (322.41, 129.9), (322.62, 166.48)]
points_2 = [(204.56, 173.85), (204.3, 186.84), (14.63, 169.86), (14.87, 164.07), (14.87, 164.07), (20.98, 162.58), 
            (13.13, 140.22), (14.63, 169.86), (14.87, 164.07), (20.98, 162.58), (9.83, 181.0), (12.33, 129.4), (13.44, 199.58), 
            (14.63, 169.86), (14.87, 164.07), (14.87, 164.07), (15.29, 156.84), (15.85, 140.35), (15.85, 140.35), (16.4, 213.27),
              (20.26, 197.34), (21.52, 100.84), (21.24, 133.09), (21.9, 140.13), (22.91, 105.65), (22.37, 204.85), 
              (25.63, 122.28), (25.8, 119.05), (26.47, 100.96), (25.88, 152.45), (26.31, 192.08), (26.61, 186.45),
                (26.82, 176.87), (26.82, 176.87), (27.01, 157.27), (26.89, 171.9), (27.13, 165.75), (27.13, 165.75), 
                (28.25, 149.79), (28.66, 137.63), (30.24, 100.37), (30.24, 100.37), (30.04, 132.26), (30.76, 112.63), 
                (30.57, 199.68), (30.74, 186.67), (32.08, 128.7), (33.96, 101.31), (33.96, 101.31), (33.63, 138.47)]

pt1 = [(320.28, 227.1), (322.41, 129.9), (331.14, 192.68), (346.7, 214.12), (360.86, 130.76), 
      (370.8, 199.62), (370.96, 183.74), (371.22, 230.48), (371.85, 236.25), (372.96, 189.0),
        (378.56, 131.95), (378.73, 206.8), (380.92, 221.4), (382.11, 135.67), (382.62, 148.92), (386.71, 90.87),
        (388.33, 232.84), (392.19, 218.04), (399.1, 217.52), (399.1, 217.52), (403.75, 223.94), (408.72, 225.81)]
pt2 = [(30.57, 199.68), (33.96, 101.31), (42.02, 165.08), (57.62, 186.89), (72.82, 103.32), (82.25, 172.55), (82.5, 156.61),
       (82.06, 203.45), (82.79, 209.24), (84.26, 161.96), (90.58, 104.75), (90.16, 179.84), (92.13, 194.49), (94.23, 108.67), 
       (94.62, 121.92), (98.91, 63.88), (99.28, 205.92), (103.22, 191.13), (110.18, 190.84), (110.18, 190.84), (114.77, 197.14), 
       (119.59, 199.1)]

p1 = [(320.28, 227.1), (322.41, 129.9), (331.14, 192.68), (346.7, 214.12)]
p2 = [(30.57, 199.68), (33.96, 101.31), (42.02, 165.08), (57.62, 186.89)]

p1 = np.array(p1[0:4])
p2 = np.array(p2[0:4])

chosen_pts_1 = np.ones((p1.shape[0],p1.shape[1]+1))
chosen_pts_1[:,0:p1.shape[1]] = p1

chosen_pts_2 = np.ones((p2.shape[0],p2.shape[1]+1))
chosen_pts_2[:,0:p2.shape[1]] = p2

def ransac(pts_1, pts_2):
    
    A = compute_matrix(pts_1, pts_2)

    combined_matrix = np.transpose(A)@A

        # Perform singular value decomposition (SVD)
    U, S, Vt = np.linalg.svd(combined_matrix)

    # Extract the row corresponding to the smallest singular value
    h_vector = Vt[-1, :]

    # Reshape the vector into a 3x3 matrix
    h_matrix = h_vector.reshape(3, 3) / h_vector[8]
    '''
    eigen_values, eigen_vectors = np.linalg.eig(combined_matrix)
    least_index = np.argmin(eigen_values)

    h_vector = eigen_vectors[least_index]
    h_matrix = h_vector.reshape(3, 3)/h_vector[8]
    '''
    print(h_matrix)

    (H, status) = cv2.findHomography(pts_1, pts_2, cv2.RANSAC)

    
    print(H)

    for i,p in enumerate(pts_1):
        predicted_p2 = H @ p
        #print(pts_2[i],predicted_p2/predicted_p2[-1])
        #print('-------------')
ransac(chosen_pts_1, chosen_pts_2)


